<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Áßª‰Ωè„Åï„Åå„Åó</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans JP',sans-serif; background:#f4f1eb; height:100dvh; display:flex; flex-direction:column; overflow:hidden; }

header {
background:#fff; border-bottom:1px solid #e0dbd2;
display:flex; align-items:center; gap:12px;
padding:0 16px; height:52px; flex-shrink:0;
box-shadow:0 1px 6px rgba(0,0,0,0.06); z-index:1000;
}
.logo { font-size:18px; font-weight:700; color:#3a6b4a; letter-spacing:1px; white-space:nowrap; }
.logo span { color:#e07b39; }
.search-bar { flex:1; background:#f4f1eb; border-radius:8px; display:flex; align-items:center; padding:7px 12px; gap:6px; }
.search-bar input { border:none; background:transparent; font-family:inherit; font-size:13px; outline:none; width:100%; color:#333; }

.filter-bar {
background:#fff; border-bottom:1px solid #e8e4dc;
padding:10px 12px; display:flex; gap:6px; overflow-x:auto; flex-shrink:0; z-index:999;
}
.filter-bar::-webkit-scrollbar { display:none; }
.chip { padding:6px 14px; border-radius:50px; font-size:12px; white-space:nowrap; border:1.5px solid #ddd; background:white; color:#666; cursor:pointer; font-family:inherit; flex-shrink:0; transition:all 0.15s; }
.chip.active-green { border-color:#3a6b4a; background:#3a6b4a; color:white; font-weight:700; }
.chip.active-orange { border-color:#e07b39; background:#e07b39; color:white; font-weight:700; }

.main { display:flex; flex:1; overflow:hidden; position:relative; }
#map { flex:1; z-index:1; }

/* PC „Çµ„Ç§„Éâ„Éë„Éç„É´ */
.panel { width:280px; background:#fff; border-left:1px solid #e0dbd2; display:flex; flex-direction:column; overflow:hidden; z-index:2; }
.panel-count { padding:12px 14px 8px; font-size:12px; color:#888; border-bottom:1px solid #f0ede6; flex-shrink:0; }
.panel-count strong { color:#3a6b4a; font-size:16px; }
.panel-list { flex:1; overflow-y:auto; }

.pitem { display:flex; gap:10px; padding:12px 14px; border-bottom:1px solid #f4f1eb; cursor:pointer; transition:background 0.15s; }
.pitem:hover, .pitem.active { background:#f0f7f2; }
.pitem-emoji { width:48px; height:44px; border-radius:8px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:22px; }
.pitem-name { font-size:12px; font-weight:700; color:#222; line-height:1.3; margin-bottom:2px; }
.pitem-loc { font-size:10px; color:#999; margin-bottom:4px; }
.pitem-tags { display:flex; gap:3px; flex-wrap:wrap; }
.ptag { font-size:9px; padding:2px 6px; border-radius:3px; background:#f4f1eb; color:#777; }

/* „Çπ„Éû„Éõ „Éú„Éà„É†„Ç∑„Éº„Éà */
.bottom-sheet {
display:none;
position:fixed; left:0; right:0; bottom:0; z-index:500;
background:#fff; border-radius:16px 16px 0 0;
box-shadow:0 -4px 20px rgba(0,0,0,0.12);
flex-direction:column;
max-height:55dvh;
padding-bottom:env(safe-area-inset-bottom, 0px);
transition: max-height 0.3s ease;
}
.sheet-handle { display:flex; align-items:center; justify-content:space-between; padding:10px 16px 6px; flex-shrink:0; cursor:pointer; }
.sheet-handle-bar { width:36px; height:4px; background:#ddd; border-radius:4px; }
.sheet-count { font-size:12px; color:#888; }
.sheet-count strong { color:#3a6b4a; font-size:15px; }
.sheet-list { overflow-y:auto; flex:1; }

/* „Çπ„Éû„Éõ ‚Üë„Éú„Çø„É≥ */
.up-btn {
  position:fixed;
  right:16px;
  bottom:24px;
  z-index:9999;
  width:52px; height:52px;
  border-radius:50%;
  background:white;
  border:2px solid #ccc;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);
  cursor:pointer;
  opacity:0;
  pointer-events:none;
  transition: opacity 0.2s;
}
.up-btn.visible {
  opacity:1;
  pointer-events:auto;
}

/* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
.leaflet-popup-content-wrapper { border-radius:14px !important; box-shadow:0 8px 24px rgba(0,0,0,0.15) !important; padding:0 !important; overflow:hidden; }
.leaflet-popup-content { margin:0 !important; width:240px !important; }
.popup-img { height:100px; display:flex; align-items:center; justify-content:center; font-size:44px; }
.popup-body { padding:12px 14px; }
.popup-name { font-size:13px; font-weight:700; color:#222; margin-bottom:3px; }
.popup-loc { font-size:11px; color:#999; margin-bottom:8px; }
.popup-tags { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:10px; }
.popup-tag { font-size:10px; padding:2px 8px; border-radius:4px; background:#f4f1eb; color:#777; }
.popup-price { font-size:13px; font-weight:700; margin-bottom:10px; }

.popup-link {
  display:block; width:fit-content; margin:0 auto;
  padding:9px 24px; border-radius:8px;
  color:#fff !important;
  font-family:inherit; font-size:12px; cursor:pointer;
  font-weight:700; text-decoration:none !important;
  text-align:center;
}
.popup-link:visited, .popup-link:hover, .popup-link:active {
  color:#fff !important;
  text-decoration:none !important;
}
.popup-nolink {
  display:block; width:fit-content; margin:0 auto;
  padding:9px 24px; border-radius:8px;
  color:#fff !important; font-family:inherit;
  font-size:12px; font-weight:500; text-align:center; opacity:0.4;
}

@media (max-width:640px) {
  .panel { display:none; }
  .bottom-sheet { display:flex; }
}
@media (min-width:641px) {
  .up-btn { display:none !important; }
}
</style>

</head>
<body>

<header>
  <div class="logo">Áßª‰Ωè<span>„Åï„Åå„Åó</span></div>
  <div class="search-bar">
    <span style="color:#bbb;font-size:13px">üîç</span>
    <input type="text" id="search" placeholder="Âú∞Âêç„ÉªÊñΩË®≠Âêç„ÅßÊ§úÁ¥¢...">
  </div>
</header>

<div class="filter-bar">
  <button class="chip active-green" data-type="all">„Åô„Åπ„Å¶</button>
  <button class="chip" data-type="trial">„ÅäË©¶„ÅóÁßª‰Ωè</button>
  <button class="chip" data-type="dual">‰∫åÊã†ÁÇπÊñΩË®≠</button>
  <button class="chip" data-type="share">„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ</button>
  <div style="width:1px;background:#e8e4dc;margin:0 4px;flex-shrink:0"></div>
  <button class="chip active-orange" data-area="all">ÂÖ®ÂõΩ</button>
  <button class="chip" data-area="hokkaido">ÂåóÊµ∑ÈÅì</button>
  <button class="chip" data-area="tohoku">Êù±Âåó</button>
  <button class="chip" data-area="kanto">Èñ¢Êù±</button>
  <button class="chip" data-area="chubu">‰∏≠ÈÉ®</button>
  <button class="chip" data-area="kinki">ËøëÁïø</button>
  <button class="chip" data-area="chugoku">‰∏≠ÂõΩ</button>
  <button class="chip" data-area="shikoku">ÂõõÂõΩ</button>
  <button class="chip" data-area="kyushu">‰πùÂ∑û</button>
</div>

<div class="main">
  <div id="map"></div>

  <div class="panel">
    <div class="panel-count"><strong id="count">0</strong> ‰ª∂Ë°®Á§∫‰∏≠</div>
    <div class="panel-list" id="panel-list"></div>
  </div>

  <div class="bottom-sheet" id="bottom-sheet">
    <div class="sheet-handle" id="sheet-handle">
      <div class="sheet-handle-bar" style="margin:0 auto;"></div>
      <span class="sheet-count"><strong id="count2">0</strong> ‰ª∂</span>
    </div>
    <div class="sheet-list" id="sheet-list"></div>
  </div>
</div>

<button class="up-btn" id="up-btn">‚Üë</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
const facilities = [
  { id:1,  name:"ÂåóÊµ∑ÈÅì„Éã„Çª„Ç≥ „ÅäË©¶„Åó‰ΩèÂÆÖ",     area:"hokkaido", type:"trial", emoji:"üèîÔ∏è", location:"ÂåóÊµ∑ÈÅìËôªÁî∞ÈÉ°„Éã„Çª„Ç≥Áî∫",   tags:["„ÅäË©¶„ÅóÁßª‰Ωè","„Éö„ÉÉ„ÉàÂèØ","Ê∏©Ê≥âÂú∞"],    price:"¬•3,500„Äú/Ê≥ä", lat:42.804, lng:140.687 },
  { id:2,  name:"ÂáΩÈ§® ‰∫åÊã†ÁÇπ„Éô„Éº„Çπ",           area:"hokkaido", type:"dual",  emoji:"ü¶ë", location:"ÂåóÊµ∑ÈÅìÂáΩÈ§®Â∏Ç",          tags:["‰∫åÊã†ÁÇπ","Êµ∑„ÅåË¶ã„Åà„Çã","„Ç≥„ÉØ„Éº„Ç≠„É≥„Ç∞"], price:"¬•45,000„Äú/Êúà", lat:41.773, lng:140.726 },
  { id:3,  name:"ÂºòÂâç „Çä„Çì„Åî„ÅÆÂÆ∂",             area:"tohoku",   type:"share", emoji:"üçé", location:"ÈùíÊ£ÆÁúåÂºòÂâçÂ∏Ç",          tags:["„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ","Ëæ≤Ê•≠‰ΩìÈ®ì","Ë£úÂä©Èáë„ÅÇ„Çä"],price:"¬•35,000„Äú/Êúà", lat:40.602, lng:140.464 },
  { id:4,  name:"‰ªôÂè∞ „Çµ„ÉÜ„É©„Ç§„Éà„Ç™„Éï„Ç£„Çπ‰ªò„Åç", area:"tohoku",   type:"dual",  emoji:"üèôÔ∏è", location:"ÂÆÆÂüéÁúå‰ªôÂè∞Â∏Ç",          tags:["‰∫åÊã†ÁÇπ","„Ç≥„ÉØ„Éº„Ç≠„É≥„Ç∞‰ªò"],           price:"¬•60,000„Äú/Êúà", lat:38.269, lng:140.869 },
  { id:5,  name:"ÈÇ£È†àÈ´òÂéü Ê£Æ„ÅÆ„Ç∑„Çß„Ç¢",         area:"kanto",    type:"share", emoji:"üå≤", location:"Ê†ÉÊú®ÁúåÈÇ£È†àÁî∫",          tags:["„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ","Â±±„ÉªËá™ÁÑ∂","„Éö„ÉÉ„ÉàÂèØ"],  price:"¬•50,000„Äú/Êúà", lat:37.066, lng:140.047 },
  { id:6,  name:"ËëâÂ±± „ÅäË©¶„ÅóÊöÆ„Çâ„Åó",           area:"kanto",    type:"trial", emoji:"üåä", location:"Á•ûÂ•àÂ∑ùÁúåËëâÂ±±Áî∫",        tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Êµ∑„ÅåË¶ã„Åà„Çã","Â≠êÈÄ£„ÇåOK"], price:"¬•5,000„Äú/Ê≥ä",  lat:35.273, lng:139.576 },
  { id:7,  name:"ËªΩ‰∫ïÊ≤¢ „ÉØ„Éº„Ç±„Éº„Ç∑„Éß„É≥„Éô„Éº„Çπ", area:"kanto",    type:"dual",  emoji:"üèïÔ∏è", location:"Èï∑ÈáéÁúåËªΩ‰∫ïÊ≤¢Áî∫",        tags:["‰∫åÊã†ÁÇπ","Â±±„ÉªËá™ÁÑ∂","„Ç≥„ÉØ„Éº„Ç≠„É≥„Ç∞‰ªò"], price:"¬•80,000„Äú/Êúà", lat:36.348, lng:138.600 },
  { id:8,  name:"ÁôΩÂ∑ùÈÉ∑ Âè§Ê∞ëÂÆ∂„Çπ„ÉÜ„Ç§",         area:"chubu",    type:"trial", emoji:"üè°", location:"Â≤êÈòúÁúåÁôΩÂ∑ùÊùë",          tags:["„ÅäË©¶„ÅóÁßª‰Ωè","‰∏ñÁïåÈÅ∫Áî£","Ë£úÂä©Èáë„ÅÇ„Çä"], price:"¬•6,000„Äú/Ê≥ä",  lat:36.254, lng:136.906 },
  { id:9,  name:"Âçó‰ºäË±Ü Êµ∑Ëæ∫„ÅÆ‰∫åÊã†ÁÇπ",         area:"chubu",    type:"dual",  emoji:"üê†", location:"ÈùôÂ≤°ÁúåÂçó‰ºäË±ÜÁî∫",        tags:["‰∫åÊã†ÁÇπ","Êµ∑„ÅåË¶ã„Åà„Çã","„Éö„ÉÉ„ÉàÂèØ"],     price:"¬•55,000„Äú/Êúà", lat:34.620, lng:138.797 },
  { id:10, name:"‰∫¨ÈÉΩË•øÈô£ Áî∫ÂÆ∂„Ç∑„Çß„Ç¢",         area:"kinki",    type:"share", emoji:"‚õ©Ô∏è", location:"‰∫¨ÈÉΩÂ∫ú‰∫¨ÈÉΩÂ∏Ç",          tags:["„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ","Áî∫ÂÆ∂","„Ç≥„ÉØ„Éº„Ç≠„É≥„Ç∞‰ªò"],price:"¬•58,000„Äú/Êúà", lat:35.026, lng:135.745 },
  { id:11, name:"Ê∑°Ë∑ØÂ≥∂ „ÉØ„Éº„Ç±„Éº„Ç∑„Éß„É≥",       area:"kinki",    type:"dual",  emoji:"üå∫", location:"ÂÖµÂ∫´ÁúåÊ∑°Ë∑ØÂ∏Ç",          tags:["‰∫åÊã†ÁÇπ","Êµ∑„ÅåË¶ã„Åà„Çã","Ê∏©Ê≥âÂú∞"],       price:"¬•45,000„Äú/Êúà", lat:34.424, lng:134.896 },
  { id:12, name:"Â∞æÈÅì ÂùÇ„ÅÆ‰∏ä„ÅÆ„ÅäË©¶„Åó‰ΩèÂÆÖ",     area:"chugoku",  type:"trial", emoji:"üé®", location:"Â∫ÉÂ≥∂ÁúåÂ∞æÈÅìÂ∏Ç",          tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Êµ∑„ÅåË¶ã„Åà„Çã","„Ç¢„Éº„Éà"],   price:"¬•2,500„Äú/Ê≥ä",  lat:34.408, lng:133.196 },
  { id:13, name:"È´òÁü•Âõõ‰∏áÂçÅ Ëá™ÁÑ∂ÊöÆ„Çâ„Åó‰ΩìÈ®ì",   area:"shikoku",  type:"trial", emoji:"üêü", location:"È´òÁü•ÁúåÂõõ‰∏áÂçÅÂ∏Ç",        tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Â±±„ÉªËá™ÁÑ∂","Ë£úÂä©Èáë„ÅÇ„Çä"], price:"¬•3,000„Äú/Ê≥ä",  lat:33.014, lng:132.939 },
  { id:14, name:"Á≥∏Â≥∂ Êµ∑„Å®Â±±„ÅÆ„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ",   area:"kyushu",   type:"share", emoji:"üåÖ", location:"Á¶èÂ≤°ÁúåÁ≥∏Â≥∂Â∏Ç",          tags:["„Ç∑„Çß„Ç¢„Éè„Ç¶„Çπ","Êµ∑„ÅåË¶ã„Åà„Çã","Â≠êÈÄ£„ÇåOK"],price:"¬•40,000„Äú/Êúà", lat:33.551, lng:130.197 },
  { id:15, name:"Â±ã‰πÖÂ≥∂ Ê£Æ„ÅÆÊöÆ„Çâ„Åó‰ΩìÈ®ì",       area:"kyushu",   type:"trial", emoji:"üåø", location:"ÈπøÂÖêÂ≥∂ÁúåÂ±ã‰πÖÂ≥∂Áî∫",      tags:["„ÅäË©¶„ÅóÁßª‰Ωè","‰∏ñÁïåÈÅ∫Áî£","Â±±„ÉªËá™ÁÑ∂"],   price:"¬•7,000„Äú/Ê≥ä",  lat:30.337, lng:130.527 },
  { id:16, name:"Á¥≤ya -„ÉÑ„Éä„ÇÆ„É§-",            area:"kinki",    type:"trial", emoji:"üèòÔ∏è", location:"ÊªãË≥ÄÁúåÁ±≥ÂéüÂ∏ÇÈï∑Â≤°1300",   tags:["„ÅäË©¶„ÅóÁßª‰Ωè","‰∏ÄÊ£üË≤∏Âàá","Áßª‰ΩèÁõ∏Ë´á"],   price:"¬•8,800„Äú/Ê≥ä",  lat:35.319, lng:136.447, url:"https://tsunagiya-knw.jp/" },
  { id:17, name:"Áß©Áà∂Êùâ„ÅÆÂÆ∂„ÄåÁµÜ„Äç", area:"kanto", type:"trial", emoji:"üè†", location:"ÂüºÁéâÁúåÁß©Áà∂Â∏ÇÈáéÂùÇÁî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","ÁÑ°Êñô","Áßª‰ΩèÁõ∏Ë´á"], price:"ÁÑ°ÊñôÔºàÈ£≤È£üË≤ª„ÅØËá™Â∑±Ë≤†ÊãÖÔºâ", lat:35.991, lng:139.079, url:"https://www.chichibu-iju.com/otameshi.html" },
  { id:18, name:"„ÇÜ„Éº„ÇÜ„Éº„Ç≠„É£„Éì„É≥", area:"kanto", type:"trial", emoji:"üèïÔ∏è", location:"Ê†ÉÊú®ÁúåÂ§ßÁî∞ÂéüÂ∏ÇÊπØÊ¥•‰∏ä", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Ê∏©Ê≥â‰ªò„Åç","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂"], price:"¬•2,000„Äú/Êó•", lat:36.823, lng:140.173, url:"https://ohtawara-ijyu.jp/" },
  { id:19, name:"„Éõ„Çø„É´„ÅÆÂÆ∂", area:"kanto", type:"trial", emoji:"üèöÔ∏è", location:"Á•ûÂ•àÂ∑ùÁúåË∂≥ÊüÑ‰∏äÈÉ°Â±±ÂåóÁî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Âè§Ê∞ëÂÆ∂","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂"], price:"Ë¶ÅÂïèÂêà„Åõ", lat:35.366, lng:139.079, url:"https://www.town.yamakita.kanagawa.jp/" },
  { id:20, name:"Â§ß‰∫ïÁî∫„ÅäË©¶„Åó‰ΩèÂÆÖ", area:"kanto", type:"trial", emoji:"üåø", location:"Á•ûÂ•àÂ∑ùÁúåË∂≥ÊüÑ‰∏äÈÉ°Â§ß‰∫ïÁî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂","Ëæ≤Ê•≠‰ΩìÈ®ì"], price:"¬•20,000„Äú/2ÈÄ±Èñì", lat:35.335, lng:139.119, url:"https://www.town.oi.kanagawa.jp/site/iju/otamesijutaku.html" },
  { id:21, name:"Â∑ùÊ†πÊú¨Áî∫„ÅäË©¶„Åó‰ΩèÂÆÖ", area:"chubu", type:"trial", emoji:"üçµ", location:"ÈùôÂ≤°ÁúåÊ¶õÂéüÈÉ°Â∑ùÊ†πÊú¨Áî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Â∑ùÊ†πËå∂","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂"], price:"ÁÑ°Êñô", lat:35.118, lng:138.087, url:"https://www.town.kawanehon.shizuoka.jp/" },
  { id:22, name:"Ë•ø‰ºäË±ÜÁî∫„ÅäË©¶„ÅóÁßª‰Ωè‰ΩèÂÆÖ", area:"chubu", type:"trial", emoji:"üåÖ", location:"ÈùôÂ≤°ÁúåË≥ÄËåÇÈÉ°Ë•ø‰ºäË±ÜÁî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Â§ïÊó•ÁôæÈÅ∏","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂"], price:"¬•1,000/Êó•", lat:34.769, lng:138.777, url:"https://iju.pref.shizuoka.jp/measure/503.html" },
  { id:23, name:"ÂÆâÊõáÈáéÂ∏Ç„Åä„Åü„ÇÅ„Åó‰ΩèÂÆÖ", area:"chubu", type:"trial", emoji:"üèîÔ∏è", location:"Èï∑ÈáéÁúåÂÆâÊõáÈáéÂ∏Ç", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Âåó„Ç¢„É´„Éó„Çπ","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂"], price:"ÁÑ°Êñô", lat:36.303, lng:137.903, url:"https://www.city.azumino.nagano.jp/" },
  { id:24, name:"‰ø°ÊøÉÁî∫„ÅäË©¶„Åó‰ΩèÂÆÖ", area:"chubu", type:"trial", emoji:"üå≤", location:"Èï∑ÈáéÁúå‰∏äÊ∞¥ÂÜÖÈÉ°‰ø°ÊøÉÁî∫", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂","6Ê≥äÁÑ°Êñô"], price:"6Ê≥äÁÑ°Êñô„Äú", lat:36.847, lng:138.198, url:"https://www.town.shinano.lg.jp/" },
  { id:25, name:"„ÅÑ„Åô„ÅøÂ∏Ç„ÅäË©¶„ÅóÂ±Ö‰Ωè", area:"kanto", type:"trial", emoji:"üåä", location:"ÂçÉËëâÁúå„ÅÑ„Åô„ÅøÂ∏Ç", tags:["„ÅäË©¶„ÅóÁßª‰Ωè","Ëá™Ê≤ª‰ΩìÈÅãÂñ∂","ÊúÄÂ§ß1ÈÄ±Èñì"], price:"ÁÑ°Êñô", lat:35.254, lng:140.369, url:"https://www.city.isumi.lg.jp/" },
];

const typeColors = {
  trial: { btn:"#3a6b4a", bg:"#eef5f0", text:"#3a6b4a", img:"#c8dfc0" },
  dual:  { btn:"#4a7ab5", bg:"#e8f0f8", text:"#4a7ab5", img:"#a8c4dc" },
  share: { btn:"#e07b39", bg:"#fef0e6", text:"#e07b39", img:"#f0c8a0" },
};
const areaBounds = {
  all:     [[24,122],[46,146]],
  hokkaido:[[41,139],[46,146]],
  tohoku:  [[37,138],[42,142]],
  kanto:   [[34,136],[38,141]],
  chubu:   [[33,135],[38,140]],
  kinki:   [[33,134],[36,137]],
  chugoku: [[33,130],[36,135]],
  shikoku: [[32,132],[34,135]],
  kyushu:  [[28,128],[34,133]],
};

let typeFilter = "all";
let areaFilter = "all";
let query = "";
let markers = [];
let sheetExpanded = true;

// 2ÊôÇÈñìÂúèÂÜÖ ‚âí Á¥Ñ150km „ÇíÁ∑ØÂ∫¶ÁµåÂ∫¶„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„Å´ÊèõÁÆóÔºàÁ∑ØÂ∫¶1Â∫¶‚âí111kmÔºâ
const TWO_HOUR_DEG = 0.5; // Á¥Ñ55kmÂàÜ

// IP„Ç∏„Ç™„É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅßÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„ÄÅ2ÊôÇÈñìÂúèÂÜÖ„ÇíÂàùÊúüË°®Á§∫
// ÂèñÂæó„Åß„Åç„Å™„Åë„Çå„Å∞ÂÖ®ÂõΩË°®Á§∫„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
async function getInitialBounds() {
  try {
    const res = await fetch("https://ipapi.co/json/");
    const data = await res.json();
    if (data && data.latitude && data.longitude) {
      const lat = parseFloat(data.latitude);
      const lng = parseFloat(data.longitude);
      // Êó•Êú¨ÂõΩÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
      if (lat >= 24 && lat <= 46 && lng >= 122 && lng <= 146) {
        return [
          [lat - TWO_HOUR_DEG, lng - TWO_HOUR_DEG * 1.4],
          [lat + TWO_HOUR_DEG, lng + TWO_HOUR_DEG * 1.4]
        ];
      }
    }
  } catch(e) {
    // ÂèñÂæóÂ§±ÊïóÊôÇ„ÅØÂÖ®ÂõΩË°®Á§∫
  }
  return areaBounds.all;
}

const map = L.map('map').fitBounds(areaBounds.all);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'¬© OpenStreetMap contributors', maxZoom:18
}).addTo(map);

// ÂàùÊúüË°®Á§∫ÔºöIP„Ç∏„Ç™„É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅßÁèæÂú®Âú∞„Åã„Çâ2ÊôÇÈñìÂúèÂÜÖ„Å´Ë®≠ÂÆö
getInitialBounds().then(bounds => {
  map.fitBounds(bounds, { animate: false });
  render();
});

function createIcon(f) {
  const c = typeColors[f.type];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40">
    <path d="M16 0C7.16 0 0 7.16 0 16c0 11 16 24 16 24s16-13 16-24C32 7.16 24.84 0 16 0z" fill="${c.btn}" opacity="0.95"/>
    <circle cx="16" cy="15" r="9" fill="white"/>
    <text x="16" y="19" text-anchor="middle" font-size="11">${f.emoji}</text>
  </svg>`;
  return L.divIcon({ html:svg, iconSize:[32,40], iconAnchor:[16,40], popupAnchor:[0,-42], className:'' });
}

const sheet = document.getElementById("bottom-sheet");
const upBtn = document.getElementById("up-btn");

function isMobile() { return window.innerWidth <= 640; }

function expandSheet() {
  sheetExpanded = true;
  sheet.style.maxHeight = "55dvh";
  upBtn.classList.remove("visible");
}

function collapseSheet() {
  sheetExpanded = false;
  sheet.style.maxHeight = "0px";
  if (isMobile()) upBtn.classList.add("visible");
}

const handle = document.getElementById("sheet-handle");
let touchStartY = 0;
handle.addEventListener("touchstart", e => { touchStartY = e.touches[0].clientY; }, { passive:true });
handle.addEventListener("touchend", e => {
  const diff = e.changedTouches[0].clientY - touchStartY;
  if (diff > 10) collapseSheet();
  else if (diff < -10) expandSheet();
  else sheetExpanded ? collapseSheet() : expandSheet();
}, { passive:true });
handle.addEventListener("click", () => { sheetExpanded ? collapseSheet() : expandSheet(); });

upBtn.addEventListener("click", expandSheet);
map.on("click", () => { if(isMobile()) collapseSheet(); });

function render() {
  const filtered = facilities.filter(f => {
    if (typeFilter !== "all" && f.type !== typeFilter) return false;
    if (areaFilter !== "all" && f.area !== areaFilter) return false;
    if (query && !f.name.includes(query) && !f.location.includes(query)) return false;
    return true;
  });

  markers.forEach(m => map.removeLayer(m));
  markers = [];
  filtered.forEach(f => {
    const tc = typeColors[f.type];
    const marker = L.marker([f.lat, f.lng], { icon: createIcon(f) }).addTo(map);
    const btnHtml = f.url
      ? `<a class="popup-link" href="${f.url}" target="_blank" style="background:${tc.btn}">Ë©≥Á¥∞„ÇíË¶ã„Çã ‚Üí</a>`
      : `<span class="popup-nolink" style="background:${tc.btn}">Ë©≥Á¥∞Ê∫ñÂÇô‰∏≠</span>`;
    marker.bindPopup(`
      <div class="popup-img" style="background:${tc.img}">${f.emoji}</div>
      <div class="popup-body">
        <div class="popup-name">${f.name}</div>
        <div class="popup-loc">üìç ${f.location}</div>
        <div class="popup-tags">${f.tags.map(t=>`<span class="popup-tag">${t}</span>`).join('')}</div>
        <div class="popup-price" style="color:${tc.text}">${f.price}</div>
        ${btnHtml}
      </div>`, { maxWidth:240 });
    markers.push(marker);
  });

  // „Ç®„É™„Ç¢„Éï„Ç£„É´„Çø„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„Å°„Çâ„ÇíÂÑ™ÂÖà
  if (areaFilter !== "all") {
    map.fitBounds(areaBounds[areaFilter], { animate:true });
  }

  document.getElementById("count").textContent = filtered.length;
  document.getElementById("count2").textContent = filtered.length;

  const html = filtered.map((f,i) => {
    const tc = typeColors[f.type];
    return `<div class="pitem" data-idx="${i}" onclick="focusMarker(${i})">
      <div class="pitem-emoji" style="background:${tc.img}">${f.emoji}</div>
      <div>
        <div class="pitem-name">${f.name}</div>
        <div class="pitem-loc">üìç ${f.location}</div>
        <div class="pitem-tags">${f.tags.slice(0,2).map(t=>`<span class="ptag">${t}</span>`).join('')}</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById("panel-list").innerHTML = html;
  document.getElementById("sheet-list").innerHTML = html;
  window._filtered = filtered;
}

function focusMarker(idx) {
  const f = window._filtered[idx];
  map.setView([f.lat, f.lng], 11, { animate:true });
  markers[idx].openPopup();
  document.querySelectorAll('.pitem').forEach(el => el.classList.remove('active'));
  document.querySelectorAll(`.pitem[data-idx="${idx}"]`).forEach(el => el.classList.add('active'));
  if(isMobile()) collapseSheet();
}

document.querySelectorAll("[data-type]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-type]").forEach(b => b.className="chip");
    btn.classList.add("active-green");
    typeFilter = btn.dataset.type;
    render();
  });
});
document.querySelectorAll("[data-area]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-area]").forEach(b => b.className="chip");
    btn.classList.add("active-orange");
    areaFilter = btn.dataset.area;
    render();
  });
});
document.getElementById("search").addEventListener("input", e => {
  query = e.target.value;
  render();
});
</script>

</body>
</html>
