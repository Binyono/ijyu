<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ç§»ä½ã•ãŒã—</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans JP',sans-serif; background:#f4f1eb; height:100dvh; display:flex; flex-direction:column; overflow:hidden; }

header {
  background:#fff; border-bottom:1px solid #e0dbd2;
  display:flex; align-items:center; gap:12px;
  padding:0 16px; height:52px; flex-shrink:0;
  box-shadow:0 1px 6px rgba(0,0,0,0.06); z-index:1000;
}
.logo { font-size:18px; font-weight:700; color:#3a6b4a; letter-spacing:1px; white-space:nowrap; }
.logo span { color:#e07b39; }
.search-bar {
  flex:1; background:#f4f1eb; border-radius:8px;
  display:flex; align-items:center; padding:7px 12px; gap:6px;
}
.search-bar input { border:none; background:transparent; font-family:inherit; font-size:13px; outline:none; width:100%; color:#333; }
.search-bar input::placeholder { color:#bbb; }

.filter-bar {
  background:#fff; border-bottom:1px solid #e8e4dc;
  padding:10px 12px; display:flex; gap:6px; overflow-x:auto; flex-shrink:0;
  z-index:999;
}
.filter-bar::-webkit-scrollbar { display:none; }
.chip {
  padding:6px 14px; border-radius:50px; font-size:12px; white-space:nowrap;
  border:1.5px solid #ddd; background:white; color:#666;
  cursor:pointer; font-family:inherit; flex-shrink:0; transition:all 0.15s;
}
.chip.active-green { border-color:#3a6b4a; background:#3a6b4a; color:white; font-weight:700; }
.chip.active-orange { border-color:#e07b39; background:#e07b39; color:white; font-weight:700; }

.main { display:flex; flex:1; overflow:hidden; position:relative; }

#map { flex:1; z-index:1; } .leaflet-container { z-index:1 !important; }

/* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆPCï¼‰ */
.panel {
  width:280px; background:#fff; border-left:1px solid #e0dbd2;
  display:flex; flex-direction:column; overflow:hidden; z-index:2;
}
.panel-count {
  padding:12px 14px 8px; font-size:12px; color:#888;
  border-bottom:1px solid #f0ede6; flex-shrink:0;
}
.panel-count strong { color:#3a6b4a; font-size:16px; }
.panel-list { flex:1; overflow-y:auto; }
.panel-list::-webkit-scrollbar { width:3px; }
.panel-list::-webkit-scrollbar-thumb { background:#ddd; border-radius:3px; }

.pitem {
  display:flex; gap:10px; padding:12px 14px;
  border-bottom:1px solid #f4f1eb; cursor:pointer; transition:background 0.15s;
}
.pitem:hover, .pitem.active { background:#f0f7f2; }
.pitem-emoji {
  width:48px; height:44px; border-radius:8px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:22px;
}
.pitem-name { font-size:12px; font-weight:700; color:#222; line-height:1.3; margin-bottom:2px; }
.pitem-loc { font-size:10px; color:#999; margin-bottom:4px; }
.pitem-tags { display:flex; gap:3px; flex-wrap:wrap; }
.ptag { font-size:9px; padding:2px 6px; border-radius:3px; background:#f4f1eb; color:#777; }

/* ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆï¼ˆã‚¹ãƒãƒ›ï¼‰ */
.bottom-sheet {
  display:none;
  position:fixed; bottom:0; left:0; right:0; z-index:999;
  background:#fff; border-radius:16px 16px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,0.12);
  max-height:45vh; flex-direction:column;
}
.sheet-handle {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 16px 6px; flex-shrink:0; cursor:pointer;
}
.sheet-handle-bar {
  width:36px; height:4px; background:#ddd; border-radius:4px; margin:0 auto;
}
.sheet-count { font-size:12px; color:#888; }
.sheet-count strong { color:#3a6b4a; font-size:15px; }
.sheet-list { overflow-y:auto; flex:1; }

/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
.leaflet-popup-content-wrapper {
  border-radius:14px !important;
  box-shadow:0 8px 24px rgba(0,0,0,0.15) !important;
  padding:0 !important; overflow:hidden;
}
.leaflet-popup-content { margin:0 !important; width:240px !important; }
.popup-img {
  height:100px; display:flex; align-items:center;
  justify-content:center; font-size:44px;
}
.popup-body { padding:12px 14px; }
.popup-name { font-size:13px; font-weight:700; color:#222; margin-bottom:3px; }
.popup-loc { font-size:11px; color:#999; margin-bottom:8px; }
.popup-tags { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:10px; }
.popup-tag { font-size:10px; padding:2px 8px; border-radius:4px; background:#f4f1eb; color:#777; }
.popup-price { font-size:13px; font-weight:700; margin-bottom:10px; }
.popup-btn {
  display:block; width:100%; padding:9px; border:none; border-radius:8px;
  color:white; font-family:inherit; font-size:12px; cursor:pointer; font-weight:500;
}

#up-btn { display:none !important; }
@media (max-width:640px) {
  #up-btn.visible { display:flex !important; }
  .panel { display:none; }
  .bottom-sheet {
    display:flex;
    position:fixed; bottom:0; left:0; right:0; z-index:999;
    max-height:60vh;
  }
}
</style>
</head>
<body>

<header>
  <div class="logo">ç§»ä½<span>ã•ãŒã—</span></div>
  <div class="search-bar">
    <span style="color:#bbb;font-size:13px">ğŸ”</span>
    <input type="text" id="search" placeholder="åœ°åãƒ»æ–½è¨­åã§æ¤œç´¢...">
  </div>
</header>

<div class="filter-bar">
  <button class="chip active-green" data-type="all">ã™ã¹ã¦</button>
  <button class="chip" data-type="trial">ãŠè©¦ã—ç§»ä½</button>
  <button class="chip" data-type="dual">äºŒæ‹ ç‚¹æ–½è¨­</button>
  <button class="chip" data-type="share">ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹</button>
  <div style="width:1px;background:#e8e4dc;margin:0 4px;flex-shrink:0"></div>
  <button class="chip active-orange" data-area="all">å…¨å›½</button>
  <button class="chip" data-area="hokkaido">åŒ—æµ·é“</button>
  <button class="chip" data-area="tohoku">æ±åŒ—</button>
  <button class="chip" data-area="kanto">é–¢æ±</button>
  <button class="chip" data-area="chubu">ä¸­éƒ¨</button>
  <button class="chip" data-area="kinki">è¿‘ç•¿</button>
  <button class="chip" data-area="chugoku">ä¸­å›½</button>
  <button class="chip" data-area="shikoku">å››å›½</button>
  <button class="chip" data-area="kyushu">ä¹å·</button>
</div>

<div class="main">
  <div id="map"></div>

  <!-- PC ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
  <div class="panel">
    <div class="panel-count"><strong id="count">15</strong> ä»¶è¡¨ç¤ºä¸­</div>
    <div class="panel-list" id="panel-list"></div>
  </div>

  <!-- ã‚¹ãƒãƒ› ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ -->
  <div class="bottom-sheet" id="bottom-sheet" style="max-height:60dvh;">
    <div class="sheet-handle" id="sheet-toggle">
      <div style="flex:1"></div>
      <div class="sheet-handle-bar"></div>
      <div style="flex:1;text-align:right">
        <span class="sheet-count"><strong id="count2">0</strong> ä»¶</span>
      </div>
    </div>
    <div class="sheet-list" id="sheet-list"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const facilities = [
  { id:1,  name:"åŒ—æµ·é“ãƒ‹ã‚»ã‚³ ãŠè©¦ã—ä½å®…",     area:"hokkaido", type:"trial", emoji:"ğŸ”ï¸", location:"åŒ—æµ·é“è™»ç”°éƒ¡ãƒ‹ã‚»ã‚³ç”º",   tags:["ãŠè©¦ã—ç§»ä½","ãƒšãƒƒãƒˆå¯","æ¸©æ³‰åœ°"],    price:"Â¥3,500ã€œ/æ³Š", lat:42.804, lng:140.687 },
  { id:2,  name:"å‡½é¤¨ äºŒæ‹ ç‚¹ãƒ™ãƒ¼ã‚¹",           area:"hokkaido", type:"dual",  emoji:"ğŸ¦‘", location:"åŒ—æµ·é“å‡½é¤¨å¸‚",          tags:["äºŒæ‹ ç‚¹","æµ·ãŒè¦‹ãˆã‚‹","ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°"], price:"Â¥45,000ã€œ/æœˆ", lat:41.773, lng:140.726 },
  { id:3,  name:"å¼˜å‰ ã‚Šã‚“ã”ã®å®¶",             area:"tohoku",   type:"share", emoji:"ğŸ", location:"é’æ£®çœŒå¼˜å‰å¸‚",          tags:["ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹","è¾²æ¥­ä½“é¨“","è£œåŠ©é‡‘ã‚ã‚Š"],price:"Â¥35,000ã€œ/æœˆ", lat:40.602, lng:140.464 },
  { id:4,  name:"ä»™å° ã‚µãƒ†ãƒ©ã‚¤ãƒˆã‚ªãƒ•ã‚£ã‚¹ä»˜ã", area:"tohoku",   type:"dual",  emoji:"ğŸ™ï¸", location:"å®®åŸçœŒä»™å°å¸‚",          tags:["äºŒæ‹ ç‚¹","ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ä»˜"],           price:"Â¥60,000ã€œ/æœˆ", lat:38.269, lng:140.869 },
  { id:5,  name:"é‚£é ˆé«˜åŸ æ£®ã®ã‚·ã‚§ã‚¢",         area:"kanto",    type:"share", emoji:"ğŸŒ²", location:"æ ƒæœ¨çœŒé‚£é ˆç”º",          tags:["ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹","å±±ãƒ»è‡ªç„¶","ãƒšãƒƒãƒˆå¯"],  price:"Â¥50,000ã€œ/æœˆ", lat:37.066, lng:140.047 },
  { id:6,  name:"è‘‰å±± ãŠè©¦ã—æš®ã‚‰ã—",           area:"kanto",    type:"trial", emoji:"ğŸŒŠ", location:"ç¥å¥ˆå·çœŒè‘‰å±±ç”º",        tags:["ãŠè©¦ã—ç§»ä½","æµ·ãŒè¦‹ãˆã‚‹","å­é€£ã‚ŒOK"], price:"Â¥5,000ã€œ/æ³Š",  lat:35.273, lng:139.576 },
  { id:7,  name:"è»½äº•æ²¢ ãƒ¯ãƒ¼ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹", area:"kanto",    type:"dual",  emoji:"ğŸ•ï¸", location:"é•·é‡çœŒè»½äº•æ²¢ç”º",        tags:["äºŒæ‹ ç‚¹","å±±ãƒ»è‡ªç„¶","ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ä»˜"], price:"Â¥80,000ã€œ/æœˆ", lat:36.348, lng:138.600 },
  { id:8,  name:"ç™½å·éƒ· å¤æ°‘å®¶ã‚¹ãƒ†ã‚¤",         area:"chubu",    type:"trial", emoji:"ğŸ¡", location:"å²é˜œçœŒç™½å·æ‘",          tags:["ãŠè©¦ã—ç§»ä½","ä¸–ç•Œéºç”£","è£œåŠ©é‡‘ã‚ã‚Š"], price:"Â¥6,000ã€œ/æ³Š",  lat:36.254, lng:136.906 },
  { id:9,  name:"å—ä¼Šè±† æµ·è¾ºã®äºŒæ‹ ç‚¹",         area:"chubu",    type:"dual",  emoji:"ğŸ ", location:"é™å²¡çœŒå—ä¼Šè±†ç”º",        tags:["äºŒæ‹ ç‚¹","æµ·ãŒè¦‹ãˆã‚‹","ãƒšãƒƒãƒˆå¯"],     price:"Â¥55,000ã€œ/æœˆ", lat:34.620, lng:138.797 },
  { id:10, name:"äº¬éƒ½è¥¿é™£ ç”ºå®¶ã‚·ã‚§ã‚¢",         area:"kinki",    type:"share", emoji:"â›©ï¸", location:"äº¬éƒ½åºœäº¬éƒ½å¸‚",          tags:["ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹","ç”ºå®¶","ã‚³ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ä»˜"],price:"Â¥58,000ã€œ/æœˆ", lat:35.026, lng:135.745 },
  { id:11, name:"æ·¡è·¯å³¶ ãƒ¯ãƒ¼ã‚±ãƒ¼ã‚·ãƒ§ãƒ³",       area:"kinki",    type:"dual",  emoji:"ğŸŒº", location:"å…µåº«çœŒæ·¡è·¯å¸‚",          tags:["äºŒæ‹ ç‚¹","æµ·ãŒè¦‹ãˆã‚‹","æ¸©æ³‰åœ°"],       price:"Â¥45,000ã€œ/æœˆ", lat:34.424, lng:134.896 },
  { id:12, name:"å°¾é“ å‚ã®ä¸Šã®ãŠè©¦ã—ä½å®…",     area:"chugoku",  type:"trial", emoji:"ğŸ¨", location:"åºƒå³¶çœŒå°¾é“å¸‚",          tags:["ãŠè©¦ã—ç§»ä½","æµ·ãŒè¦‹ãˆã‚‹","ã‚¢ãƒ¼ãƒˆ"],   price:"Â¥2,500ã€œ/æ³Š",  lat:34.408, lng:133.196 },
  { id:13, name:"é«˜çŸ¥å››ä¸‡å è‡ªç„¶æš®ã‚‰ã—ä½“é¨“",   area:"shikoku",  type:"trial", emoji:"ğŸŸ", location:"é«˜çŸ¥çœŒå››ä¸‡åå¸‚",        tags:["ãŠè©¦ã—ç§»ä½","å±±ãƒ»è‡ªç„¶","è£œåŠ©é‡‘ã‚ã‚Š"], price:"Â¥3,000ã€œ/æ³Š",  lat:33.014, lng:132.939 },
  { id:14, name:"ç³¸å³¶ æµ·ã¨å±±ã®ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹",   area:"kyushu",   type:"share", emoji:"ğŸŒ…", location:"ç¦å²¡çœŒç³¸å³¶å¸‚",          tags:["ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹","æµ·ãŒè¦‹ãˆã‚‹","å­é€£ã‚ŒOK"],price:"Â¥40,000ã€œ/æœˆ", lat:33.551, lng:130.197 },
  { id:15, name:"å±‹ä¹…å³¶ æ£®ã®æš®ã‚‰ã—ä½“é¨“",       area:"kyushu",   type:"trial", emoji:"ğŸŒ¿", location:"é¹¿å…å³¶çœŒå±‹ä¹…å³¶ç”º",      tags:["ãŠè©¦ã—ç§»ä½","ä¸–ç•Œéºç”£","å±±ãƒ»è‡ªç„¶"],   price:"Â¥7,000ã€œ/æ³Š",  lat:30.337, lng:130.527 },
  // === è‡ªæ²»ä½“é‹å–¶æ–½è¨­ ===
  { id:18, name:"ã‚†ãƒ¼ã‚†ãƒ¼ã‚­ãƒ£ãƒ“ãƒ³", area:"kanto", type:"trial", emoji:"ğŸ•ï¸", location:"æ ƒæœ¨çœŒå¤§ç”°åŸå¸‚æ¹¯æ´¥ä¸Š", tags:["ãŠè©¦ã—ç§»ä½","æ¸©æ³‰ä»˜ã","è‡ªæ²»ä½“é‹å–¶"], price:"Â¥2,000ã€œ/æ—¥", lat:36.823, lng:140.173, url:"https://ohtawara-ijyu.jp/" },
  { id:19, name:"ãƒ›ã‚¿ãƒ«ã®å®¶", area:"kanto", type:"trial", emoji:"ğŸšï¸", location:"ç¥å¥ˆå·çœŒè¶³æŸ„ä¸Šéƒ¡å±±åŒ—ç”º", tags:["ãŠè©¦ã—ç§»ä½","å¤æ°‘å®¶","è‡ªæ²»ä½“é‹å–¶"], price:"è¦å•åˆã›", lat:35.366, lng:139.079, url:"https://www.town.yamakita.kanagawa.jp/" },
  { id:20, name:"å¤§äº•ç”ºãŠè©¦ã—ä½å®…", area:"kanto", type:"trial", emoji:"ğŸŒ¿", location:"ç¥å¥ˆå·çœŒè¶³æŸ„ä¸Šéƒ¡å¤§äº•ç”º", tags:["ãŠè©¦ã—ç§»ä½","è‡ªæ²»ä½“é‹å–¶","è¾²æ¥­ä½“é¨“"], price:"Â¥20,000ã€œ/2é€±é–“", lat:35.335, lng:139.119, url:"https://www.town.oi.kanagawa.jp/site/iju/otamesijutaku.html" },
  { id:21, name:"å·æ ¹æœ¬ç”ºãŠè©¦ã—ä½å®…", area:"chubu", type:"trial", emoji:"ğŸµ", location:"é™å²¡çœŒæ¦›åŸéƒ¡å·æ ¹æœ¬ç”º", tags:["ãŠè©¦ã—ç§»ä½","å·æ ¹èŒ¶","è‡ªæ²»ä½“é‹å–¶"], price:"ç„¡æ–™", lat:35.118, lng:138.087, url:"https://www.town.kawanehon.shizuoka.jp/" },
  { id:22, name:"è¥¿ä¼Šè±†ç”ºãŠè©¦ã—ç§»ä½ä½å®…", area:"chubu", type:"trial", emoji:"ğŸŒ…", location:"é™å²¡çœŒè³€èŒ‚éƒ¡è¥¿ä¼Šè±†ç”º", tags:["ãŠè©¦ã—ç§»ä½","å¤•æ—¥ç™¾é¸","è‡ªæ²»ä½“é‹å–¶"], price:"Â¥1,000/æ—¥", lat:34.769, lng:138.777, url:"https://iju.pref.shizuoka.jp/measure/503.html" },
  { id:23, name:"å®‰æ›‡é‡å¸‚ãŠãŸã‚ã—ä½å®…", area:"chubu", type:"trial", emoji:"ğŸ”ï¸", location:"é•·é‡çœŒå®‰æ›‡é‡å¸‚", tags:["ãŠè©¦ã—ç§»ä½","åŒ—ã‚¢ãƒ«ãƒ—ã‚¹","è‡ªæ²»ä½“é‹å–¶"], price:"ç„¡æ–™", lat:36.303, lng:137.903, url:"https://www.city.azumino.nagano.jp/" },
  { id:24, name:"ä¿¡æ¿ƒç”ºãŠè©¦ã—ä½å®…", area:"chubu", type:"trial", emoji:"ğŸŒ²", location:"é•·é‡çœŒä¸Šæ°´å†…éƒ¡ä¿¡æ¿ƒç”ºå¤§å­—å¯Œæ¿ƒ3772-1", tags:["ãŠè©¦ã—ç§»ä½","è‡ªæ²»ä½“é‹å–¶","6æ³Šç„¡æ–™"], price:"6æ³Šç„¡æ–™ã€œ", lat:36.847, lng:138.198, url:"https://www.town.shinano.lg.jp/" },
  { id:25, name:"ã„ã™ã¿å¸‚ãŠè©¦ã—å±…ä½", area:"kanto", type:"trial", emoji:"ğŸŒŠ", location:"åƒè‘‰çœŒã„ã™ã¿å¸‚", tags:["ãŠè©¦ã—ç§»ä½","è‡ªæ²»ä½“é‹å–¶","æœ€å¤§1é€±é–“"], price:"ç„¡æ–™", lat:35.254, lng:140.369, url:"https://www.city.isumi.lg.jp/" },
  { id:17, name:"ç§©çˆ¶æ‰ã®å®¶ã€Œçµ†ã€", area:"kanto", type:"trial", emoji:"ğŸ ", location:"åŸ¼ç‰çœŒç§©çˆ¶å¸‚é‡å‚ç”º", tags:["ãŠè©¦ã—ç§»ä½","ç„¡æ–™","ç§»ä½ç›¸è«‡"], price:"ç„¡æ–™ï¼ˆé£²é£Ÿè²»ã¯è‡ªå·±è² æ‹…ï¼‰", lat:35.991, lng:139.079, url:"https://www.chichibu-iju.com/otameshi.html" },
  { id:16, name:"ç´²ya -ãƒ„ãƒŠã‚®ãƒ¤-",            area:"kinki",    type:"trial", emoji:"ğŸ˜ï¸", location:"æ»‹è³€çœŒç±³åŸå¸‚é•·å²¡1300",   tags:["ãŠè©¦ã—ç§»ä½","ä¸€æ£Ÿè²¸åˆ‡","ç§»ä½ç›¸è«‡"],   price:"Â¥8,800ã€œ/æ³Š",  lat:35.319, lng:136.447, url:"https://tsunagiya-knw.jp/" },
];

const typeColors = {
  trial: { btn:"#3a6b4a", bg:"#eef5f0", text:"#3a6b4a", img:"#c8dfc0" },
  dual:  { btn:"#4a7ab5", bg:"#e8f0f8", text:"#4a7ab5", img:"#a8c4dc" },
  share: { btn:"#e07b39", bg:"#fef0e6", text:"#e07b39", img:"#f0c8a0" },
};
const typeLabel = { trial:"ãŠè©¦ã—ç§»ä½", dual:"äºŒæ‹ ç‚¹æ–½è¨­", share:"ã‚·ã‚§ã‚¢ãƒã‚¦ã‚¹" };
const areaBounds = {
  all:     [[24,122],[46,146]],
  hokkaido:[[41,139],[46,146]],
  tohoku:  [[37,138],[42,142]],
  kanto:   [[34,136],[38,141]],
  chubu:   [[33,135],[38,140]],
  kinki:   [[33,134],[36,137]],
  chugoku: [[33,130],[36,135]],
  shikoku: [[32,132],[34,135]],
  kyushu:  [[28,128],[34,133]],
};

let typeFilter = "all";
let areaFilter = "all";
let query = "";
let markers = [];
let sheetOpen = true;

// åœ°å›³åˆæœŸåŒ–
const map = L.map('map').fitBounds(areaBounds.all);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© OpenStreetMap contributors', maxZoom:18
}).addTo(map);

function createIcon(f) {
  const c = typeColors[f.type];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40">
    <path d="M16 0C7.16 0 0 7.16 0 16c0 11 16 24 16 24s16-13 16-24C32 7.16 24.84 0 16 0z" fill="${c.btn}" opacity="0.95"/>
    <circle cx="16" cy="15" r="9" fill="white"/>
    <text x="16" y="19" text-anchor="middle" font-size="11">${f.emoji}</text>
  </svg>`;
  return L.divIcon({ html:svg, iconSize:[32,40], iconAnchor:[16,40], popupAnchor:[0,-42], className:'' });
}

function render() {
  const filtered = facilities.filter(f => {
    if (typeFilter !== "all" && f.type !== typeFilter) return false;
    if (areaFilter !== "all" && f.area !== areaFilter) return false;
    if (query && !f.name.includes(query) && !f.location.includes(query)) return false;
    return true;
  });

  // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  filtered.forEach(f => {
    const tc = typeColors[f.type];
    const marker = L.marker([f.lat, f.lng], { icon: createIcon(f) }).addTo(map);
    const popup = `
      <div class="popup-img" style="background:${tc.img}">${f.emoji}</div>
      <div class="popup-body">
        <div class="popup-name">${f.name}</div>
        <div class="popup-loc">ğŸ“ ${f.location}</div>
        <div class="popup-tags">${f.tags.map(t=>`<span class="popup-tag">${t}</span>`).join('')}</div>
        <div class="popup-price" style="color:${tc.text}">${f.price}</div>
        ${f.url ? `<a class="popup-btn" href="${f.url}" target="_blank" style="background:${tc.btn};text-decoration:none;color:white;display:block;width:fit-content;margin:0 auto;padding:9px 24px;border-radius:8px;font-size:13px;font-weight:500">è©³ç´°ã‚’è¦‹ã‚‹ â†’</a>` : `<button class="popup-btn" style="background:${tc.btn};opacity:0.4;cursor:default">è©³ç´°æº–å‚™ä¸­</button>`}
      </div>`;
    marker.bindPopup(popup, { maxWidth:240 });
    markers.push(marker);
  });

  // ã‚¨ãƒªã‚¢ç§»å‹•
  map.fitBounds(areaBounds[areaFilter] || areaBounds.all, { animate:true });

  // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
  document.getElementById("count").textContent = filtered.length;
  document.getElementById("count2").textContent = filtered.length;

  // ãƒªã‚¹ãƒˆç”Ÿæˆ
  const html = filtered.map((f,i) => {
    const tc = typeColors[f.type];
    return `<div class="pitem" data-idx="${i}" onclick="focusMarker(${i})">
      <div class="pitem-emoji" style="background:${tc.img}">${f.emoji}</div>
      <div>
        <div class="pitem-name">${f.name}</div>
        <div class="pitem-loc">ğŸ“ ${f.location}</div>
        <div class="pitem-tags">${f.tags.slice(0,2).map(t=>`<span class="ptag">${t}</span>`).join('')}</div>
      </div>
    </div>`;
  }).join('');
  document.getElementById("panel-list").innerHTML = html;
  document.getElementById("sheet-list").innerHTML = html;

  window._filtered = filtered;
}

function focusMarker(idx) {
  const f = window._filtered[idx];
  map.setView([f.lat, f.lng], 11, { animate:true });
  markers[idx].openPopup();
  document.querySelectorAll('.pitem').forEach(el => el.classList.remove('active'));
  document.querySelectorAll(`.pitem[data-idx="${idx}"]`).forEach(el => el.classList.add('active'));
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
document.querySelectorAll("[data-type]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-type]").forEach(b => b.className="chip");
    btn.classList.add("active-green");
    typeFilter = btn.dataset.type;
    render();
  });
});
document.querySelectorAll("[data-area]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("[data-area]").forEach(b => b.className="chip");
    btn.classList.add("active-orange");
    areaFilter = btn.dataset.area;
    render();
  });
});
document.getElementById("search").addEventListener("input", e => {
  query = e.target.value;
  render();
});

// ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆé–‹é–‰
const sheet = document.getElementById("bottom-sheet");
const handle = document.getElementById("sheet-toggle");
let sheetExpanded = false;
let touchStartY = 0;

function expandSheet() {
  sheetExpanded = true;
  sheet.style.transition = "max-height 0.3s ease";
  sheet.style.maxHeight = "60dvh";
  document.getElementById("up-btn").classList.remove("visible");
}
function collapseSheet() {
  sheetExpanded = false;
  sheet.style.transition = "max-height 0.3s ease";
  sheet.style.maxHeight = "0px";
  document.getElementById("up-btn").classList.add("visible");
}

handle.addEventListener("touchstart", e => {
  touchStartY = e.touches[0].clientY;
}, { passive: true });

handle.addEventListener("touchend", e => {
  const diff = e.changedTouches[0].clientY - touchStartY;
  if (Math.abs(diff) < 10) {
    sheetExpanded ? collapseSheet() : expandSheet();
  } else if (diff < -10) {
    expandSheet();
  } else if (diff > 10) {
    collapseSheet();
  }
}, { passive: true });

handle.addEventListener("click", () => {
  sheetExpanded ? collapseSheet() : expandSheet();
});

map.on("click", () => { collapseSheet(); });

render();
</script>
<div id="up-btn" onclick="expandSheet();" style="display:none;position:fixed;right:16px;bottom:calc(100px + env(safe-area-inset-bottom, 80px));z-index:9999;width:52px;height:52px;border-radius:50%;background:white;border:2px solid #ccc;font-size:22px;align-items:center;justify-content:center;box-shadow:0 2px 12px rgba(0,0,0,0.15);cursor:pointer;">â†‘</div>
</body>
</html>
